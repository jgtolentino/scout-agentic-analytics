TABLE_NAME                                                                                                                       VIEW_DEFINITION                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
-------------------------------------------------------------------------------------------------------------------------------- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
v_flat_export_sheet                                                                                                              -- ========================================================================
-- CREATE CORRECTED FLAT EXPORT VIEW
-- ========================================================================

CREATE   VIEW dbo.v_flat_export_sheet AS
WITH demo_agg AS (
  -- Aggregate SalesInteractions to prevent row multiplication
  SELECT
    canonical_tx_id,
    -- Use MAX to get one value per transaction
    MAX(CASE
      WHEN Age BETWEEN 18 AND 24 THEN '18-24'
      WHEN Age BETWEEN 25 AND 34 THEN '25-34'
      WHEN Age BETWEEN 35 AND 44 THEN '35-44'
      WHEN Age BETWEEN 45 AND 54 THEN '45-54'
      WHEN Age BETWEEN 55 AND 64 THEN '55-64'
      WHEN Age >= 65 THEN '65+'
      ELSE ''
    END) AS age_bracket,
    MAX(Gender) AS gender
  FROM dbo.SalesInteractions
  WHERE canonical_tx_id IS NOT NULL
  GROUP BY canonical_tx_id
),
vib_agg AS (
  -- Aggregate v_insight_base to prevent row multiplication
  SELECT
    sessionId AS canonical_tx_id,
    MAX(CASE
      WHEN substitution_event = '1' THEN 'true'
      WHEN substitution_event = '0' THEN 'false'
      ELSE ''
    END) AS substitution_flag
  FROM dbo.v_insight_base
  WHERE sessionId IS NOT NULL
  GROUP BY sessionId
)
SELECT
  CAST(p.canonical_tx_id AS varchar(64)) AS Transaction_ID,
  CAST(p.total_amount AS decimal(18,2)) AS Transaction_Value,
  CAST(p.total_items AS int) AS Basket_Size,
  p.category AS Category,
  p.brand AS Brand,
  p.daypart AS Daypart,
  -- Demographics with inferred persona role: "Age Gender Role"
  LTRIM(RTRIM(CONCAT(
    COALESCE(d.age_bracket, ''),
    CASE WHEN COALESCE(d.gender, '') != '' THEN ' ' + d.gender ELSE '' END,
    CASE WHEN COALESCE(pr.role, '') != '' AND COALESCE(pr.role, '') != 'Regular'
         THEN ' ' + pr.role ELSE '' END
  ))) AS [Demographics (Age/Gender/Role)],
  p.weekday_weekend AS Weekday_vs_Weekend,
  FORMAT(p.txn_ts, 'htt', 'en-US') AS [Time of transaction],
  p.store_name AS Location,
  -- Other_Products: Simplified empty for now
  '' AS Other_Products,
  COALESCE(v.substitution_flag, '') AS Was_Substitution
FROM dbo.v_transactions_flat_production p
LEFT JOIN demo_agg d ON d.canonical_tx_id = p.canonical_tx_id
LEFT JOIN vib_agg v ON v.canonical_tx_id = p.canonical_tx_id
LEFT JOIN ref.v_persona_inference pr ON pr.canonical_tx_id = p.canonical_tx_id;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        

(1 row affected)
